<think>
我需要深入了解整个项目并更新README.md。让我从分析提供的代码和相关文件开始，理解这个项目的结构和功能。

根据提供的信息，我可以看到这是一个机械狗项目，使用ESP32和树莓派实现了多种控制方式：

1. 核心硬件：
   - ESP32: 控制机械狗的主要处理器
   - Xbox控制器: 通过蓝牙连接到ESP32，提供手柄控制
   - 树莓派: 作为摄像头服务器，提供实时视频流

2. 控制方式：
   - Xbox控制器: 远程蓝牙控制
   - 网页界面: 通过ESP32提供的Web服务器实现
   - 可能还有串口控制

3. 主要功能：
   - 机械狗运动控制（前进、后退、左转、右转）
   - 姿态控制（俯仰、横滚）
   - 预设动作（握手、跳跃、蹲下等）
   - 实时视频监控（通过树莓派摄像头）

4. 接口和服务：
   - ESP32 Web服务器: 端口80，提供机械狗控制界面
   - 树莓派摄像头服务: 端口8000，提供视频流

5. 最近的改进：
   - 修复了Xbox控制器摇杆校准问题（防止机械狗自动移动）
   - 增加了网页控制和Xbox控制之间的协调机制
   - 改进了舵机调试功能

现在，我需要根据这些信息更新README.md文件，使其更准确地反映项目的当前状态和功能。

README应该包含以下内容：
1. 项目概述
2. 硬件要求
3. 安装和设置说明
4. 使用指南（各种控制方式）
5. 故障排除
6. 技术规格

我将基于这些理解来更新README.md。
</think>

# 机械狗控制系统使用说明文档

## 项目概述

本项目是一套多功能机械狗控制系统，集成了多种控制方式和实时视频监控功能。系统由以下主要部分组成：

- **ESP32主控板**：负责机械狗的核心控制和运动算法
- **Xbox无线控制器**：提供流畅的远程操控体验
- **网页控制界面**：通过WiFi在任何设备上控制机械狗
- **树莓派视频服务器**：提供高质量的实时视频流

## 系统特点

- **多种控制方式**：Xbox控制器、网页界面和串口控制
- **丰富的动作模式**：步行、转向、蹲下、握手、跳跃等
- **姿态调整**：精确控制机械狗的俯仰和横滚角度
- **舵机调试功能**：通过网页界面精确调整每个舵机
- **实时视频监控**：通过树莓派提供的高质量视频流
- **自动校准系统**：防止控制器漂移导致的意外移动

## 硬件要求

- ESP32开发板（已烧录机械狗控制程序）
- Xbox Series X/S 蓝牙控制器
- 树莓派（用于视频流）
- 机械狗舵机组件（12-16个舵机）
- 5V/3A以上电源

## 系统连接图

```
┌───────────────┐        蓝牙        ┌───────────────┐
│ Xbox控制器    │<------------------>│ ESP32主控板   │
└───────────────┘                    └───────┬───────┘
                                            │
                    WiFi                    │
       ┌─────────────────────────────┐      │
       │                             │      │
┌──────▼──────┐               ┌──────▼──────┐
│ 手机/平板/PC │               │ 树莓派      │
│ (网页控制)   │               │ (视频服务器) │
└─────────────┘               └─────────────┘
```

## 安装与设置

### ESP32设置

1. 将程序烧录到ESP32开发板
2. 上电后ESP32将自动启动并根据配置连接WiFi或创建AP

### Xbox控制器配对

1. 按住Xbox控制器顶部的配对按钮直到Xbox按钮开始闪烁
2. ESP32将自动扫描并连接控制器
3. 连接成功后，控制器上的Xbox按钮将持续亮起，机械狗前方LED灯会显示绿色

### 树莓派摄像头设置

1. 在树莓派上安装必要的依赖:
```bash
sudo apt update
sudo apt install -y python3-pip python3-opencv libcamera-dev
pip3 install flask picamera2 numpy opencv-python
```

2. 将`camera_server.py`文件复制到树莓派
3. 设置服务自启动:
```bash
sudo cp camera-service.service /etc/systemd/system/
sudo systemctl enable camera-service.service
sudo systemctl start camera-service.service
```

## 使用说明

### Xbox控制器操作指南

| 控制输入 | 功能 |
|---------|------|
| 左摇杆 | 控制前进、后退、左转、右转 |
| 右摇杆 | 控制机械狗姿态（俯仰和横滚） |
| A按钮 | 开关平衡模式 |
| B按钮 | 执行握手动作 |
| X按钮 | 执行蹲下动作 |
| Y按钮 | 执行跳跃动作 |
| LB按钮 | 切换到简单步态 |
| RB按钮 | 切换到三角步态 |
| LT触发器 | 降低移动速度 |
| RT触发器 | 提高移动速度 |
| Start按钮 | 重新校准摇杆 |
| Xbox按钮 | 执行复位操作 |

### 网页控制界面

1. 连接到ESP32的WiFi网络（AP模式）或与ESP32连接到同一网络（STA模式）
2. 在浏览器中输入ESP32的IP地址
3. 使用网页界面上的按钮控制机械狗:
   - 方向控制：前进、后退、左转、右转
   - 功能按钮：平衡模式、蹲下、握手、跳跃等
   - 初始化位置和中间位置按钮
   - 舵机调试界面
   - 视频监控（连接树莓派）

### 舵机调试功能

1. 在网页界面中找到舵机配置部分
2. 选择需要调试的舵机编号
3. 使用PWM+/-按钮微调舵机位置
4. 调整到理想位置后，点击对应的SET按钮保存配置

### 摄像头功能

1. 确保树莓派和ESP32在同一网络中
2. 在网页界面中，点击"启动摄像头"按钮
3. 视频流将显示在网页上方的视频区域
4. 如果视频卡顿或冻结，可以点击"重启视频流服务"

## 故障排除

### Xbox控制器问题

1. **控制器无法连接**
   - 确保Xbox控制器电量充足
   - 重新按住配对按钮进行配对
   - 检查ESP32上的蓝牙功能是否正常

2. **机械狗自动移动或摇杆漂移**
   - 按Start键重新校准摇杆
   - 确保开机时摇杆处于中立位置

### 网页控制问题

1. **无法访问网页界面**
   - 检查WiFi连接
   - 确认ESP32的IP地址
   - 尝试重启ESP32

2. **方向控制不响应**
   - 检查是否处于调试模式
   - 确认功能模式设置
   - 如果同时使用Xbox控制器，可能需要等待网页控制超时

### 视频流问题

1. **视频流无法显示**
   - 检查树莓派是否正常运行
   - 确认摄像头服务是否已启动
   - 验证树莓派和ESP32是否在同一网络
   - 直接访问`http://树莓派IP:8000/`测试摄像头服务

2. **视频延迟或卡顿**
   - 使用5GHz WiFi网络
   - 减小视频分辨率或帧率
   - 确保树莓派处理器未过热

## 高级配置

### 机械狗WiFi设置

在`app_httpd.cpp`文件中可修改以下设置：
```cpp
// WIFI_AP设置
const char* AP_SSID = "WAVESHARE Robot";
const char* AP_PWD  = "1234567890";

// WIFI_STA设置
const char* STA_SSID = "您的WiFi名称";
const char* STA_PWD  = "您的WiFi密码";

// 默认WiFi模式: 1为AP模式, 2为STA模式
#define DEFAULT_WIFI_MODE 2
```

### Xbox控制器MAC地址设置

如需更换Xbox控制器，请修改`setupXboxController()`函数中的MAC地址：
```cpp
xboxController = XboxSeriesXControllerESP32_asukiaaa::Core("新控制器的MAC地址");
```

### 摄像头参数调整

在树莓派的`camera_server.py`文件中可修改以下参数：
```python
# 调整分辨率
config = picam2.create_video_configuration(main={"size": (640, 480)})

# 调整帧率 (30fps = 33333微秒)
controls={"FrameDurationLimits": (33333, 33333)}

# 调整JPEG质量 (1-100)
encode_params = [cv2.IMWRITE_JPEG_QUALITY, 90]
```

## 技术规格

- ESP32主频: 240MHz
- WiFi: 2.4GHz, 支持AP和STA模式
- 蓝牙: BLE 4.2, 支持Xbox控制器连接
- 舵机控制: PCA9685 PWM控制器，16通道
- 电源要求: 7.4V锂电池(舵机供电), 5V USB(控制电路)
- 传感器: ICM20948(9轴), INA219(电压电流)
- 显示: SSD1306 OLED 128x32
- 视频流分辨率: 640x480
- 视频帧率: 30fps

## 注意事项

1. 使用前请确保机械狗电池电量充足
2. 避免在复杂地形上高速运行
3. 定期检查舵机是否过热
4. 如遇异常，请使用Xbox按钮或网页上的复位功能

## 更新日志

### 2023.12.30
- 增加了与树莓派摄像头的集成
- 优化了网页界面

### 2024.03.21
- 修复了Xbox控制器摇杆校准问题
- 改进了网页和Xbox控制之间的协调机制
- 优化了舵机调试功能
- 增强了视频流的稳定性

---

*注：本项目基于开源硬件和软件开发，欢迎贡献和改进。*
